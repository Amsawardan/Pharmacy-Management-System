<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Update Profile - Raj Pharmacy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
          background-color: #f9f9f9;
          font-family: 'Poppins', sans-serif;
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
        }
        .container-box {
          background: white;
          padding: 2rem;
          border-radius: 1rem;
          box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
          width: 100%;
          max-width: 500px;
        }
        h2 {
          text-align: center;
          color: #264653;
          margin-bottom: 1.5rem;
        }
        .btn-primary {
          background: #2a9d8f;
          border: none;
          border-radius: 0.5rem;
          padding: 0.75rem;
          font-weight: bold;
        }
        .btn-primary:hover {
          background: #264653;
        }
        .btn-danger {
          background: #e76f51;
          border: none;
          border-radius: 0.5rem;
          padding: 0.75rem;
          font-weight: bold;
        }
        .btn-danger:hover {
          background: #c0392b;
        }
        .success-message, .error-message {
          margin-top: 15px;
          display: none;
          border-radius: 8px;
          padding: 10px;
          font-size: 0.9rem;
        }
        .success-message {
          background: rgba(42, 157, 143, 0.1);
          color: #2a9d8f;
        }
        .error-message {
          background: rgba(231, 111, 81, 0.1);
          color: #e76f51;
        }
        a {
          color: #2a9d8f;
        }
        a:hover {
          color: #264653;
        }
        .password-wrapper {
          position: relative;
        }
        .toggle-password {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          cursor: pointer;
          color: #264653;
        }
        .toggle-password:hover {
          color: #2a9d8f;
        }
    </style>
</head>
<body>
<div class="container-box">
    <h2>Update Your Details</h2>
    <form id="updateForm">
        <div class="mb-3">
            <label>Full Name</label>
            <input type="text" id="updateName" class="form-control" required />
        </div>
        <div class="mb-3">
            <label>Email (cannot change)</label>
            <input type="email" id="updateEmail" class="form-control" readonly />
        </div>
        <div class="mb-3 password-wrapper">
            <label>Password</label>
            <input type="password" id="updatePassword" class="form-control" required />
            <span id="togglePassword" class="toggle-password">üëÅÔ∏è</span>
        </div>
        <div class="mb-3">
            <label>Address</label>
            <input type="text" id="updateAddress" class="form-control" required />
        </div>
        <button type="submit" class="btn btn-primary w-100 mb-2">Update Details</button>
    </form>

    <button id="deleteBtn" class="btn btn-danger w-100 mb-3">Delete My Account</button>

    <div id="updateSuccess" class="success-message"></div>
    <div id="updateError" class="error-message"></div>

    <div class="mt-3 text-center">
        <a href="medicine2.html" class="text-decoration-none">Back to Home</a>
    </div>
</div>

<script>
    const USER_API_BASE = "http://localhost:8082/user";
    const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

    if (!loggedInUser) {
      alert("Please log in first!");
      window.location.href = "index.html";
    }

    // Prefill user details
    document.getElementById("updateName").value = loggedInUser.name;
    document.getElementById("updateEmail").value = loggedInUser.email;
    document.getElementById("updatePassword").value = loggedInUser.password;
    document.getElementById("updateAddress").value = loggedInUser.address;

    const updateForm = document.getElementById("updateForm");
    const successBox = document.getElementById("updateSuccess");
    const errorBox = document.getElementById("updateError");

    // Update user details
    updateForm.onsubmit = async e => {
      e.preventDefault();
      successBox.style.display = "none";
      errorBox.style.display = "none";

      const updatedUser = {
        id: loggedInUser.id,
        name: document.getElementById("updateName").value.trim(),
        email: loggedInUser.email,
        password: document.getElementById("updatePassword").value,
        address: document.getElementById("updateAddress").value.trim()
      };

      try {
        const res = await fetch(USER_API_BASE, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedUser)
        });

        if (res.ok) {
          successBox.textContent = "Your details have been updated successfully!";
          successBox.style.display = "block";
          localStorage.setItem("loggedInUser", JSON.stringify(updatedUser));
        } else {
          errorBox.textContent = "Failed to update details. Try again.";
          errorBox.style.display = "block";
        }
      } catch (err) {
        errorBox.textContent = "Network error while updating.";
        errorBox.style.display = "block";
      }
    };

    // Delete account logic
    const deleteBtn = document.getElementById("deleteBtn");
    deleteBtn.onclick = async () => {
      const confirmDelete = confirm("‚ö†Ô∏è Are you sure you want to permanently delete your account?");
      if (!confirmDelete) return;

      try {
        const res = await fetch(`${USER_API_BASE}/${loggedInUser.id}`, {
          method: "DELETE"
        });

        if (res.ok) {
          alert("Your account has been deleted successfully.");
          localStorage.removeItem("loggedInUser");
          window.location.href = "index.html";
        } else {
          alert("Failed to delete account. Try again later.");
        }
      } catch (err) {
        alert("Network error while deleting account.");
      }
    };

    // Show/Hide password
    const togglePassword = document.getElementById("togglePassword");
    const passwordInput = document.getElementById("updatePassword");

    togglePassword.onclick = () => {
      const type = passwordInput.type === "password" ? "text" : "password";
      passwordInput.type = type;
      togglePassword.textContent = type === "password" ? "üëÅÔ∏è" : "üôà";
    };
</script>
</body>
</html>
