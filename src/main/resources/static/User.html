<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login - Raj Pharmacy</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <style>
        :root {
          --primary: #2b6cb0;
          --secondary: #48bb78;
          --text-dark: #2d3748;
          --text-light: #edf2f7;
          --bg-light: #f7fafc;
        }

        body {
          background: var(--bg-light);
          font-family: 'Poppins', sans-serif;
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          margin: 0;
        }

        .container-box {
          width: 90%;
          max-width: 950px;
          display: flex;
          border-radius: 1rem;
          overflow: hidden;
          box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
          background: white;
        }

        .left {
          position: relative;
          flex: 1;
          background: url('https://cdn-icons-png.flaticon.com/512/4320/4320371.png') center/180px no-repeat,
                      linear-gradient(135deg, #2b6cb0 0%, #48bb78 100%);
          color: var(--text-light);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          padding: 3rem 2rem;
        }

        .overlay {
          position: absolute;
          top: 0; left: 0; right: 0; bottom: 0;
          background: rgba(0, 0, 0, 0.4);
          z-index: 1;
        }

        .overlay-content {
          position: relative;
          z-index: 2;
        }

        .overlay-content h1 {
          font-size: 2rem;
          font-weight: 700;
          color: #ffffff;
          margin-bottom: 1rem;
        }

        .overlay-content p {
          font-size: 1.1rem;
          color: #e2e8f0;
          max-width: 320px;
          margin: 0 auto;
        }

        .right {
          flex: 1;
          padding: 3rem 2rem;
          background: #ffffff;
          display: flex;
          flex-direction: column;
          justify-content: center;
        }

        h2 {
          font-weight: 600;
          color: var(--primary);
          margin-bottom: 1.5rem;
          text-align: center;
        }

        .form-control {
          border-radius: 0.5rem;
          padding: 0.75rem;
        }

        .btn-primary {
          background: var(--primary);
          border: none;
          padding: 0.75rem;
          border-radius: 0.5rem;
          transition: 0.2s;
        }

        .btn-primary:hover {
          background: #1e4e8c;
          transform: translateY(-1px);
        }

        .error-message {
          background: rgba(255, 0, 0, 0.08);
          color: #c53030;
          padding: 10px;
          border-radius: 8px;
          display: none;
          font-size: 0.9rem;
          margin-top: 10px;
        }

        .role-links {
          margin-top: 20px;
          text-align: center;
          border-top: 1px solid #eee;
          padding-top: 15px;
        }

        .role-links a {
          text-decoration: none;
          color: var(--primary);
          font-weight: 500;
        }

        .role-links a:hover {
          text-decoration: underline;
        }

        @media (max-width: 768px) {
          .container-box {
            flex-direction: column;
          }
          .left {
            background-size: 120px;
            padding: 2rem;
          }
        }
    </style>
</head>

<body>
<div class="container-box">
    <div class="left">
        <div class="overlay"></div>
        <div class="overlay-content">
            <h1>Welcome to Raj Pharmacy</h1>
            <p>Your trusted digital platform for secure prescriptions and user management.</p>
        </div>
    </div>

    <div class="right">
        <!-- LOGIN -->
        <div id="loginForm">
            <h2>Sign In</h2>
            <form id="login">
                <div class="mb-3">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-control" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="loginError" class="error-message"></div>
            </form>
            <p class="mt-3 text-center">
                Don't have an account?
                <a href="#" id="switchToSignup">Sign up</a>
            </p>
        </div>

        <!-- SIGNUP -->
        <div id="signupForm" style="display: none">
            <h2>Create Account</h2>
            <form id="signup">
                <div class="mb-3">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="signupName" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-control" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Address</label>
                    <input type="text" id="signupAddress" class="form-control" required />
                </div>
                <button type="submit" class="btn btn-primary w-100">Sign Up</button>
                <div id="signupError" class="error-message"></div>
            </form>
            <p class="mt-3 text-center">
                Already have an account?
                <a href="#" id="switchToLogin">Sign in</a>
            </p>
        </div>

        <div class="role-links">
            <p>Other Access Options:</p>
            <a href="/admin/login.html">
                <i class="fas fa-user-shield"></i> Login as Admin
            </a>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8082/user"; // Updated API port

    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");

    document.getElementById("switchToSignup").onclick = (e) => {
      e.preventDefault();
      loginForm.style.display = "none";
      signupForm.style.display = "block";
    };

    document.getElementById("switchToLogin").onclick = (e) => {
      e.preventDefault();
      signupForm.style.display = "none";
      loginForm.style.display = "block";
    };

    // ✅ SIGNUP - Fixed to work with your backend
    document.getElementById("signup").onsubmit = async (e) => {
      e.preventDefault();

      const user = {
        name: document.getElementById("signupName").value.trim(),
        email: document.getElementById("signupEmail").value.trim(),
        password: document.getElementById("signupPassword").value,
        address: document.getElementById("signupAddress").value.trim(),
      };

      const errorBox = document.getElementById("signupError");
      errorBox.style.display = "none";

      // Validate fields
      if (!user.name || !user.email || !user.password || !user.address) {
        errorBox.textContent = "Please fill all fields!";
        errorBox.style.display = "block";
        return;
      }

      try {
        const res = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(user),
        });

        if (res.ok) {
          // Since your backend returns void, we'll create the user object for localStorage
          const newUser = {
            id: Date.now(), // Temporary ID (backend will assign real ID)
            name: user.name,
            email: user.email,
            password: user.password,
            address: user.address,
            role: 'user' // Default role for new users
          };

          localStorage.setItem("loggedInUser", JSON.stringify(newUser));
          alert("Signup successful! Redirecting to Order page...");
          window.location.href = "http://localhost:8082/Order.html";
        } else {
          const errMsg = await res.text();
          errorBox.textContent = errMsg || "Signup failed. Try again.";
          errorBox.style.display = "block";
        }
      } catch (err) {
        errorBox.textContent = "Network error. Try again later.";
        errorBox.style.display = "block";
      }
    };

    // ✅ LOGIN - Fixed to check for admin role and redirect accordingly
    document.getElementById("login").onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;
      const errorBox = document.getElementById("loginError");
      errorBox.style.display = "none";

      try {
        const res = await fetch(API_BASE);
        if (!res.ok) throw new Error("Failed to fetch users");
        const users = await res.json();

        const user = users.find(u => u.email === email && u.password === password);
        if (user) {
          localStorage.setItem("loggedInUser", JSON.stringify(user));

          // Check if user is admin and redirect accordingly
          if (user.role === 'admin' || user.isAdmin === true) {
            alert("Admin login successful! Redirecting to Admin page...");
            window.location.href = "http://localhost:8082/admin/dashboard.html"; // Admin redirect
          } else {
            alert("Login successful! Redirecting to Order page...");
            window.location.href = "http://localhost:8082/Order.html"; // Regular user redirect
          }
        } else {
          errorBox.textContent = "Invalid email or password.";
          errorBox.style.display = "block";
        }
      } catch (err) {
        errorBox.textContent = "Error logging in. Try again later.";
        errorBox.style.display = "block";
      }
    };
</script>
</body>
</html>